<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dale Dice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    body {
      margin: 0;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      color: white;
      font-family: sans-serif;
      gap: 100px;
    }

    .scene {
      width: 200px;
      height: 200px;
      perspective: 800px;
      cursor: pointer;
    }

    .cube {
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.5s;
    }

    .face {
      position: absolute;
      width: 200px;
      height: 200px;
      backface-visibility: hidden;
    }

    .face img {
      width: 100%;
      height: 100%;
      object-fit: fill;
      border-radius: 10px;
    }

    .front {
      transform: rotateY(0deg) translateZ(100px);
    }

    .back {
      transform: rotateY(180deg) translateZ(100px);
    }

    .right {
      transform: rotateY(90deg) translateZ(100px);
    }

    .left {
      transform: rotateY(-90deg) translateZ(100px);
    }

    .top {
      transform: rotateX(90deg) translateZ(100px);
    }

    .bottom {
      transform: rotateX(-90deg) translateZ(100px);
    }
  </style>
</head>

<body>
  <div class="scene">
    <div class="cube" id="cube">
      <div class="face front"><img src="DaleCharman0.jpg" alt="1"></div>
      <div class="face back"><img src="DaleCharman1.jpg" alt="2"></div>
      <div class="face right"><img src="DaleCharman2.jpg" alt="3"></div>
      <div class="face left"><img src="DaleCharman3.jpg" alt="4"></div>
      <div class="face top"><img src="DaleCharman4.jpg" alt="5"></div>
      <div class="face bottom"><img src="DaleCharman5.jpg" alt="6"></div>
    </div>
  </div>

  <div class="scene">
    <div class="cube" id="cube2">
      <div class="face front"><img src="DaleCharman0.jpg" alt="1"></div>
      <div class="face back"><img src="DaleCharman1.jpg" alt="2"></div>
      <div class="face right"><img src="DaleCharman2.jpg" alt="3"></div>
      <div class="face left"><img src="DaleCharman3.jpg" alt="4"></div>
      <div class="face top"><img src="DaleCharman4.jpg" alt="5"></div>
      <div class="face bottom"><img src="DaleCharman5.jpg" alt="6"></div>
    </div>
  </div>

  <script>
    const cube = document.getElementById("cube");
    const cube2 = document.getElementById("cube2")
    let is_rolling = false;

    const dinoDaleGm = document.createElement("div");
    dinoDaleGm.style.position = "fixed";
    dinoDaleGm.style.top = 0;
    dinoDaleGm.style.left = 0;
    dinoDaleGm.style.width = "100%";
    dinoDaleGm.style.height = "100%";
    dinoDaleGm.style.background = "#111";
    dinoDaleGm.style.overflow = "hidden";
    dinoDaleGm.style.display = "flex";
    dinoDaleGm.style.alignItems = "flex-end";

    const dale = document.createElement("img");
    let daleImg = 0;
    dale.src = "DaleCharman0.jpg";
    dale.style.position = "absolute";
    dale.style.left = "50px";
    dale.style.bottom = "0px";
    dale.style.width = "80px";
    dale.style.height = "80px";
    dale.style.objectFit = "cover";

    const trainTrack = document.createElement("div");
    trainTrack.style.position = "absolute";
    trainTrack.style.bottom = "0";
    trainTrack.style.left = "0";
    trainTrack.style.width = "100%";
    trainTrack.style.height = "5px";
    trainTrack.style.background = "white";

    const hiScoreDisplay = document.createElement("div");
    hiScoreDisplay.style.position = "absolute";
    hiScoreDisplay.style.top = "10px";
    hiScoreDisplay.style.left = "20px";
    hiScoreDisplay.style.color = "white";
    hiScoreDisplay.style.font = "20px sans-serif";

    const scoreDisplay = document.createElement("div");
    scoreDisplay.style.position = "absolute";
    scoreDisplay.style.top = "10px";
    scoreDisplay.style.right = "20px";
    scoreDisplay.style.color = "white";
    scoreDisplay.style.font = "20px sans-serif";

    const restartBtn = document.createElement("button");
    restartBtn.textContent = "Restart";
    restartBtn.style.position = "absolute";
    restartBtn.style.top = "50%";
    restartBtn.style.left = "50%";
    restartBtn.style.transform = "translate(-50%, -50%)";
    restartBtn.style.padding = "10px 20px";
    restartBtn.style.fontSize = "20px";
    restartBtn.style.border = "none";
    restartBtn.style.borderRadius = "10px";
    restartBtn.style.background = "#fff";
    restartBtn.style.color = "#111";
    restartBtn.style.cursor = "pointer";

    const leaderBtn = document.createElement("button");
    leaderBtn.style.position = "absolute";
    leaderBtn.style.top = "50px";
    leaderBtn.style.right = "20px";
    leaderBtn.style.padding = "10px 20px";
    leaderBtn.style.fontSize = "16px";
    leaderBtn.style.border = "none";
    leaderBtn.style.borderRadius = "10px";
    leaderBtn.style.background = "#fff";
    leaderBtn.style.color = "#111";
    leaderBtn.style.cursor = "pointer";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Close";
    closeBtn.style.marginTop = "15px";
    closeBtn.style.padding = "8px 16px";
    closeBtn.style.border = "none";
    closeBtn.style.borderRadius = "8px";
    closeBtn.style.background = "#fff";
    closeBtn.style.color = "#111";
    closeBtn.style.cursor = "pointer";

    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.background = "rgba(0,0,0,0.7)";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.zIndex = 1000;

    const board = document.createElement("leaderboard");
    board.style.background = "#222";
    board.style.color = "white";
    board.style.padding = "20px";
    board.style.borderRadius = "10px";
    board.style.minWidth = "250px";
    board.style.maxHeight = "400px";
    board.style.overflowY = "auto";
    board.style.textAlign = "center";

    const API_BASE = "https://daleserver.onrender.com";

    async function submitScore(name, score, events) {
      try {
        const res = await fetch(`${API_BASE}/score`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            score,
            // events
          })
        });

        if (res.ok) {
          alert("Score submitted!");
        } else {
          const err = await res.json();
          alert("Error: " + (err.detail || "Unknown error"));
        }
      } catch (e) {
        alert("Network error: " + e.message);
      }
    }

    async function loadLeaderboard() {
      const res = await fetch(`${API_BASE}/leaderboard`);
      const data = await res.json();

      board.innerHTML = "<h2>Leaderboard</h2>";
      board.style.display = "block";
      data.forEach((entry, i) => {
        board.innerHTML += `<div>${i + 1}. ${entry.name} : ${entry.score}</div>`;
      });
    }

    function daleJmp() {
      document.body.innerHTML = "";
      document.body.appendChild(dinoDaleGm);
      dinoDaleGm.innerHTML = "";

      dinoDaleGm.appendChild(dale);

      dinoDaleGm.appendChild(trainTrack);

      let daleY = 0;
      let velocityY = 0;
      let velocityX = 0.6;
      let gravity = -0.0045;
      let isJumping = false;
      let obstacles = [];
      let events = [];
      let score = 0;
      let gameOver = false;
      let lastFrame;
      let delta;

      let hiScore = parseInt(localStorage.getItem("daleHiScore") || "0");
      hiScoreDisplay.textContent = `Hi-Score: ${hiScore}`;
      dinoDaleGm.appendChild(hiScoreDisplay);

      scoreDisplay.textContent = "Score: 0";
      dinoDaleGm.appendChild(scoreDisplay);

      restartBtn.style.display = "none";
      restartBtn.addEventListener("click", daleJmp);
      dinoDaleGm.appendChild(restartBtn);

      leaderBtn.textContent = "Show Leaderboard";

      leaderBtn.addEventListener("click", () => {
        loadLeaderboard().then(() => {
          overlay.style.display = "flex";
          loadLeaderboard();
        });
      });

      overlay.style.display = "none";
      board.style.display = "none";

      closeBtn.addEventListener("click", () => {
        overlay.style.display = "none";
        board.style.display = "none";
      });

      board.appendChild(closeBtn);
      overlay.appendChild(board);
      overlay.appendChild(closeBtn);
      dinoDaleGm.appendChild(overlay);

      dinoDaleGm.appendChild(leaderBtn);

      function jump() {
        if (!isJumping && !gameOver) {
          events.push({ event: "jmp", timestamp: performance.now() });
          velocityY = 2.5 * velocityX;
          daleImg = (daleImg + 1) % 6;
          dale.src = `DaleCharman${daleImg}.jpg`;
          isJumping = true;
        }
      }

      document.addEventListener("keydown", key => {
        if (key.code === "Space" || key.code === "ArrowUp") {
          jump();
        }
      });

      dinoDaleGm.addEventListener("click", jump);
      dinoDaleGm.addEventListener("touchstart", jump);

      function spawnObstacle() {
        if (gameOver) return;
        const obs = document.createElement("img");
        obs.src = "obs.jpg";
        obs.style.position = "absolute";
        obs.style.bottom = "0";
        obs.style.right = "0";
        obs.style.width = "40px";
        obs.style.height = "40px";
        obs.style.objectFit = "cover";

        events.push({ event: "obs spawn", timestamp: performance.now() });
        dinoDaleGm.appendChild(obs);
        obstacles.push(obs);

        setTimeout(spawnObstacle, (Math.random() * 720 + 650) / velocityX);
      }

      setTimeout(spawnObstacle, 2000);

      lastFrame = performance.now();

      function loop() {
        if (gameOver) return;
        let tnow = performance.now();
        delta = tnow - lastFrame;
        lastFrame = tnow;

        daleY += velocityY * delta;
        velocityY += gravity * delta;

        if (daleY <= 0) {
          daleY = 0;
          velocityY = 0;
          isJumping = false;
        }

        dale.style.bottom = `${daleY}px`;

        for (let obsi = score; obsi < obstacles.length; obsi++) {
          const obs = obstacles[obsi];
          obs.style.right = `${parseInt(obs.style.right, 10) + velocityX * delta}px`;
          const daleRect = dale.getBoundingClientRect();
          const obsRect = obs.getBoundingClientRect();

          if (
            daleRect.left < obsRect.right &&
            daleRect.right > obsRect.left &&
            daleRect.bottom > obsRect.top
          ) {
            gameOver = true;
            events.push({ event: "game over", timestamp: performance.now() });
            console.log(events);
            if (score > hiScore) {
              hiScore = score;
              localStorage.setItem("daleHiScore", hiScore);
              const playerName = prompt("Enter your name for the leaderboard:");
              if (playerName) {
                submitScore(playerName, hiScore, events);
              }
            }

            scoreDisplay.textContent = `Game Over! Final Score: ${score}`;
            hiScoreDisplay.textContent = `Hi-Score: ${hiScore}`;
            restartBtn.style.display = "block";
            return
          }

          if (obsRect.right < 0) {
            events.push({ event: "obs pass", timestamp: performance.now() });
            obs.remove();
            score++;
            velocityX *= 1.03;
            gravity *= 1.0609; // suvat stuff: a is prop to v^2
            scoreDisplay.textContent = `Score: ${score}`;
          }
        }

        requestAnimationFrame(loop);
      }

      loop();
    }


    const dirs = [[0, 0], [0, 180], [0, -90], [0, 90], [-90, 0], [90, 0]];

    function randSpin(rot) {
      return rot + 360 * Math.floor(Math.random() * 4 + 1);
    }

    function rollDice() {
      if (is_rolling) return;
      is_rolling = true;

      const res = Math.floor(Math.random() * 6);
      const res2 = Math.floor(Math.random() * 6);
      const [x, y] = dirs[res];
      const [x2, y2] = dirs[res2];

      cube.style.transform = `rotateX(${randSpin(x)}deg) rotateY(${randSpin(y)}deg)`;
      cube2.style.transform = `rotateX(${randSpin(x2)}deg) rotateY(${randSpin(y2)}deg)`;

      setTimeout(() => {
        is_rolling = false;
        if (res === res2) {
          daleJmp();
        }
      }, 500);
    }

    cube.addEventListener("click", rollDice);
    cube2.addEventListener("click", rollDice);
  </script>
</body>

</html>